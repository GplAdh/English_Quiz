<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quiz System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            color: #ecf0f1;
        }

        .sidebar {
            width: 250px;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .sidebar.hidden {
            transform: translateX(-250px);
            opacity: 0;
            width: 0;
            padding: 0;
        }

        .logo {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #34495e;
        }

        .nav-menu {
            list-style: none;
            margin-bottom: 30px;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-category-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 15px;
            background: #34495e;
            color: #ecf0f1;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: bold;
        }

        .nav-category-link:hover {
            background: #2c3e50;
            transform: translateX(3px);
        }

        .nav-category-link.active {
            background: #3498db;
            color: white;
        }

        .nav-category-link .fa-caret-down,
        .nav-category-link .fa-caret-up {
            margin-left: auto;
        }

        .quiz-sub-menu {
            list-style: none;
            padding-left: 25px;
            margin-top: 5px;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }

        .quiz-sub-menu.show {
            max-height: 500px;
        }

        .quiz-sub-menu li {
            margin-bottom: 5px;
        }

        .quiz-sub-menu a {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 8px 15px;
            padding-left: 10px;
            background: #2e4053;
            color: #bdc3c7;
            text-decoration: none;
            border-radius: 6px;
            transition: all 0.2s;
            gap: 8px;
        }

        .quiz-sub-menu a:hover {
            background: #34495e;
            color: #ecf0f1;
        }

        .quiz-sub-menu a.active {
            background: #2980b9;
            flex-grow : 1;
        }
        .quiz-sub-menu a.active .quiz-item-text{
            color : white
        }

        .difficulty-level-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            min-width: 30px;
            height: 30px;
            border-radius: 4px;
            color: white;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .quiz-item-text {
            flex-grow: 1;
            color: #bdc3c7;
        }

        .difficulty-easy {
            background-color: #27ae60;
        }

        .difficulty-moderate {
            background-color: #f39c12;
        }

        .difficulty-difficult {
            background-color: #c0392b;
        }

        .admin-section {
            border-top: 2px solid #34495e;
            padding-top: 20px;
        }

        .admin-title {
            font-size: 16px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 15px;
        }
        
        .admin-login-btn {
            background: #c0392b;
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
            transition: background 0.3s;
            cursor: pointer;
        }

        .admin-login-btn:hover {
            background: #a93226;
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .content-header {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            font-weight: bold;
            color: #ecf0f1;
        }

        .score-display {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
        }

        .quiz-timer {
            background: #f1c40f;
            color: #343a40;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            min-width: 120px;
            text-align: center;
        }

        .quiz-section {
            display: none;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .quiz-section.active {
            display: block;
        }

        .section-title {
            font-size: 28px;
            color: #3498db;
            margin-bottom: 20px;
            text-align: center;
        }
        .section-title-bar {
            background: linear-gradient(90deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            margin: -30px -30px 30px -30px;
            font-size: 28px;
            text-align: center;
            font-weight: bold;
        }

        .article {
            background: #34495e;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            line-height: 1.8;
            border-left: 4px solid #3498db;
            color: #ecf0f1;
        }

        .questions-container {
            display: grid;
            gap: 25px;
        }

        .question {
            background: #34495e;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #27ae60;
            color: #ecf0f1;
        }

        .question-header {
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .question-type {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .mcq-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .mcq-option {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #2c3e50;
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid #34495e;
            cursor: pointer;
            transition: all 0.3s;
            color: #ecf0f1;
        }

        .mcq-option:hover {
            border-color: #3498db;
            background: #34495e;
        }

        .mcq-option.selected {
            border-color: #3498db;
            background: #3498db;
            color: white;
        }
        
        .mcq-option input[type="radio"] {
            display: none;
        }

        .mcq-option.correct-answer-feedback {
            background: #2ecc71;
            border-color: #27ae60;
            color: white;
            pointer-events: none;
        }

        .mcq-option.incorrect-answer-feedback {
            background: #e74c3c;
            border-color: #c0392b;
            color: white;
            pointer-events: none;
        }

        .mcq-option.correct-highlight-feedback {
            background: #3498db;
            border-color: #2980b9;
            color: white;
            pointer-events: none;
        }

        .fill-blank-input, .word-answer-input {
            background: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 16px;
            margin-top: 10px;
            transition: border-color 0.3s;
            width: 100%;
            max-width: 300px;
            color: #ecf0f1;
        }

        .fill-blank-input:focus, .word-answer-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .fill-blank-input:disabled, .word-answer-input:disabled {
            background: #3d5167;
            cursor: not-allowed;
        }

        .fill-blank-input.correct-feedback, .word-answer-input.correct-feedback {
            border-color: #27ae60;
            background-color: #2ecc71;
            color: white;
            pointer-events: none;
        }

        .fill-blank-input.incorrect-feedback, .word-answer-input.incorrect-feedback {
            border-color: #c0392b;
            background-color: #e74c3c;
            color: white;
            pointer-events: none;
        }
        
        .feedback-message {
            margin-top: 8px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            display: none;
            align-items: center;
            gap: 8px;
        }
        .feedback-message.show-feedback {
            display: flex;
        }

        .feedback-message.correct {
            background-color: #2ecc71;
            color: white;
            border: 1px solid #27ae60;
        }

        .feedback-message.incorrect {
            background-color: #e74c3c;
            color: white;
            border: 1px solid #c0392b;
        }

        .feedback-message.correct i {
            color: white;
        }

        .feedback-message.incorrect i {
            color: white;
        }

        .submit-btn, .action-btn {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin: 30px auto;
            display: block;
            transition: transform 0.3s;
        }

        .submit-btn:hover, .action-btn:hover {
            transform: translateY(-2px);
        }

        .login-form, .welcome-form, .instruction-form {
            max-width: 850px;
            margin: 50px auto;
            background: #34495e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .login-form h2, .welcome-form h2, .instruction-form h2 {
            text-align: center;
            color: #3498db;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #ecf0f1;
        }

        .form-group input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            font-size: 16px;
            background: #2c3e50;
            color: #ecf0f1;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3498db;
        }

        .login-btn {
            width: 100%;
            background: #3498db;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        .admin-dashboard, .welcome-section, .introduction-section, .quiz-review-section, #submissionMessage {
            display: none;
        }

        .admin-dashboard.active, .welcome-section.active, .introduction-section.active, .quiz-review-section.active, #submissionMessage.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #34495e;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #bdc3c7;
            margin-top: 5px;
        }

        .results-table {
            background: #34495e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .results-table table {
            width: 100%;
            border-collapse: collapse;
        }

        .results-table th,
        .results-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #2c3e50;
            color: #ecf0f1;
        }

        .results-table th {
            background: #3498db;
            color: white;
        }

        .results-table tr:nth-child(even) {
            background: #2c3e50;
        }
        
        .progress-container {
            width: 100%;
            background-color: #5d6d7e;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 20px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background-color: #27ae60;
            border-radius: 10px;
            text-align: center;
            color: white;
            transition: width 0.4s ease-in-out;
            line-height: 20px;
            font-size: 12px;
        }

        .quiz-review-section .review-item {
            background: #34495e;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
            color: #ecf0f1;
        }

        .quiz-review-section .review-question-header {
            font-weight: bold;
            color: #ecf0f1;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quiz-review-section .review-answer-info {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .quiz-review-section .review-answer-info.correct {
            background-color: #2ecc71;
            color: white;
        }

        .quiz-review-section .review-answer-info.incorrect {
            background-color: #e74c3c;
            color: white;
        }

        .quiz-review-section .review-answer-info strong {
            display: block;
            margin-bottom: 5px;
        }

        .quiz-review-section .review-answer-info span {
            display: block;
        }

        .review-return-btn {
            background: #7f8c8d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            margin-top: 20px;
            display: inline-block;
        }

        .hide-timer .quiz-timer {
            display: none;
        }

        .hide-content-header .content-header {
            display: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            visibility: hidden;
            opacity: 0;
            transition: visibility 0s, opacity 0.3s ease-in-out;
            z-index: 1000;
        }

        .modal-content {
            background: #34495e;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            text-align: center;
            color: #ecf0f1;
            width: 90%;
            max-width: 400px;
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal-content h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .modal-content button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: background 0.3s;
        }

        .modal-content button:hover {
            background: #2980b9;
        }
        
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
            }
            .mcq-options {
                flex-direction: column;
            }
            .content-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .user-info, .score-display, .quiz-timer {
                width: 100%;
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">English Quiz For JEDAT </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <div class="nav-category-link" onclick="toggleSubMenu('grammar')">
                    <i class="fas fa-spell-check"></i> Grammar
                    <i class="fas fa-caret-down"></i>
                </div>
                <ul class="quiz-sub-menu" id="grammarSubMenu">
                    <li><a href="#" onclick="loadQuiz('grammar', 'BeforeWeBegin', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Before We Begin</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('grammar', 'Greetings', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Greetings</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('grammar', 'Appreciation_and_Name', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Appreciation and Name</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('grammar', 'lplace', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Place</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('grammar', 'job', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Work/Job</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('grammar', 'ending', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Ending</span>
                    </a></li>
                </ul>
            </li>
            <li class="nav-item">
                <div class="nav-category-link" onclick="toggleSubMenu('vocabulary')">
                    <i class="fas fa-language"></i> Vocabulary
                    <i class="fas fa-caret-down"></i>
                </div>
                <ul class="quiz-sub-menu" id="vocabularySubMenu">
                    <li><a href="#" onclick="loadQuiz('vocabulary', 'advancedEnglish', this)">
                        <i class="fas fa-wrench difficulty-level-icon difficulty-moderate"></i>
                        <span class="quiz-item-text">Advanced English</span>
                    </a></li>
                </ul>
            </li>
            <li class="nav-item">
                <div class="nav-category-link" onclick="toggleSubMenu('reading')">
                    <i class="fas fa-book-open"></i> Reading
                    <i class="fas fa-caret-down"></i>
                </div>
                <ul class="quiz-sub-menu" id="readingSubMenu">
                    <li><a href="#" onclick="loadQuiz('reading', 'semiconductorBasics', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Semiconductor Basics</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('reading', 'circuit', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Circuit</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('reading', 'layout', this)">
                        <i class="fas fa-wrench difficulty-level-icon difficulty-moderate"></i>
                        <span class="quiz-item-text">Layout</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('reading', 'circuitVerification', this)">
                        <i class="fas fa-wrench difficulty-level-icon difficulty-moderate"></i>
                        <span class="quiz-item-text">Circuit Verification</span>
                    </a></li>
                    <li><a href="#" onclick="loadQuiz('reading', 'layoutVerification', this)">
                        <i class="fas fa-fire difficulty-level-icon difficulty-difficult"></i>
                        <span class="quiz-item-text">Layout Verification</span>
                    </a></li>
                </ul>
            </li>
            <li class="nav-item">
                <div class="nav-category-link" onclick="toggleSubMenu('listening')">
                    <i class="fas fa-headphones"></i> Listening
                    <i class="fas fa-caret-down"></i>
                </div>
                <ul class="quiz-sub-menu" id="listeningSubMenu">
                    <li><a href="#" onclick="loadQuiz('listening', 'semiconductorDevices', this)">
                        <i class="fas fa-leaf difficulty-level-icon difficulty-easy"></i>
                        <span class="quiz-item-text">Semiconductor Devices</span>
                    </a></li>
                </ul>
            </li>
        </ul>
        <div class="admin-section">
            <div class="admin-title">Admin Panel</div>
            <a class="admin-login-btn" onclick="showAdminLogin(this)"><i class="fas fa-user-shield"></i> Admin Login</a>
        </div>
    </div>

    <div class="main-content">
        <div class="content-header">
            <div class="user-info">
                <span class="user-name" id="displayName">Guest</span>
            </div>
            <div class="score-display" id="scoreDisplay">Score: 0/0</div>
            <div class="quiz-timer" id="quizTimer">Time: --:--</div>
            <span id="quizTimeTaken" style="font-weight: bold; color: #ecf0f1; margin-left: 20px; display: none;"></span>
        </div>

        <div id="welcomeSection" class="quiz-section active">
            <div class="welcome-form">
                <div class="section-title-bar">Welcome to the English Quiz System!</div>
                <p style="text-align: center; margin-bottom: 20px; color: #ecf0f1;">Please enter your name to start the quiz.</p>
                <div class="form-group">
                    <label for="welcomeUserName">Your Name:</label>
                    <input type="text" id="welcomeUserName" placeholder="Enter your name here">
                </div>
                <button class="action-btn" onclick="startQuiz()">Start Quiz</button>
                <button class="admin-login-btn" onclick="showAdminLogin(this)" style="margin-top: 15px; width: 100%;"><i class="fas fa-user-shield"></i> Admin Login</button>
            </div>
        </div>

        <div id="introductionSection" class="quiz-section">
            <div class="instruction-form">
                <div class="section-title-bar">Quiz Instructions</div>
                <p style="color: #ecf0f1;">Welcome, <span id="introUserName" style="font-weight: bold;"></span>! Before you start the quiz, please read the following instructions carefully:</p><br>
                <ul style="color: #ecf0f1;">
                    <li>Select a quiz from the sidebar to begin.</li>
                    <li>Each quiz may contain different types of questions: Multiple Choice, Fill in the Blanks, and One Word Answers.</li>
                    <li>For Multiple Choice Questions, select one option.</li>
                    <li>For Fill in the Blanks and One Word Answers, type your answer in the provided input field.</li>
                    <li>Your answers will be saved automatically as you progress.</li>
                    <li>You must manually submit your answers by clicking the "Submit Answers" button at the end of the quiz.</li>
                    <li>The time taken for the test will be displayed after submission.</li>
                    <li>Difficulty levels are indicated by color-coded icons in the sidebar:
                        <ul>
                            <li><i class="fas fa-leaf" style="color: #27ae60;"></i> Easy quizzes</li>
                            <li><i class="fas fa-wrench" style="color: #f39c12;"></i> Moderate quizzes</li>
                            <li><i class="fas fa-fire" style="color: #c0392b;"></i> Difficult quizzes</li>
                        </ul>
                    </li>
                </ul>
                <p style="margin-top: 20px; font-weight: bold; text-align: center; color: #ecf0f1;">Good luck!</p>
                <button class="action-btn" onclick="proceedToQuiz()">Proceed to Quizzes</button>
            </div>
        </div>

        <div id="quizSection" class="quiz-section">
            <h2 class="section-title-bar" id="currentQuizTitle"></h2>
            <div class="progress-container" id="quizProgressBarContainer">
                <div class="progress-bar" id="quizProgressBar"></div>
            </div>
            <div class="article" id="currentQuizArticle"></div>
            <div class="questions-container" id="currentQuizQuestions">
                </div>
            
            <button class="submit-btn" id="currentQuizSubmitBtn" onclick="confirmSubmission()">Submit Answers</button>
            <button class="action-btn" id="retakeQuizBtn" style="display: none;" onclick="retakeQuiz()">Retake Quiz</button>
            <button class="action-btn" id="reviewQuizBtn" style="display: none; margin-left: 10px;" onclick="showQuizReview(activeQuizCategory, activeQuizTitle, currentQuizQuestions, userAnswers)">Review Quiz</button>
        </div>

        <div id="adminLoginSection" class="quiz-section">
            <div class="login-form">
                <div class="section-title-bar">Admin Login</div>
                <div class="form-group">
                    <label for="adminUsername">Username:</label>
                    <input type="text" id="adminUsername">
                </div>
                <div class="form-group">
                    <label for="adminPassword">Password:</label>
                    <input type="password" id="adminPassword">
                </div>
                <button class="login-btn" onclick="adminLogin()">Login</button>
                <button class="action-btn" onclick="showWelcomeSection()" style="margin-top: 15px; width: 100%;">Back to Welcome</button>
            </div>
        </div>

        <div id="adminDashboardSection" class="quiz-section">
            <div class="section-title-bar">Admin Dashboard</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsersStat">0</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="quizzesCompletedStat">0</div>
                    <div class="stat-label">Quizzes Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="averageScoreStat">0%</div>
                    <div class="stat-label">Average Score</div>
                </div>
            </div>
            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>User Name</th>
                            <th>Quiz Category</th>
                            <th>Quiz Title</th>
                            <th>Score</th>
                            <th>Time Taken</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminResultsTableBody">
                        </tbody>
                </table>
            </div>
            <button class="action-btn" onclick="adminLogout()">Logout</button>
            <button class="action-btn" onclick="exportData()" style="margin-left: 10px;">Export Data</button>
            <button class="action-btn" onclick="clearUserData()" style="margin-left: 10px; background: #e74c3c;">Clear All User Data</button>
        </div>

        <div id="quizReviewSection" class="quiz-section">
            <h2 class="section-title-bar" id="reviewQuizTitle"></h2>
            <div id="reviewQuestionsContainer">
                </div>
            <button class="review-return-btn" onclick="showWelcomeSection()">Return to Home</button>
        </div>

        <div id="submissionMessage" class="quiz-section">
            <div class="welcome-form">
                <div class="section-title-bar">Quiz Submitted!</div>
                <p id="finalScoreMessage" style="text-align: center; margin-bottom: 10px; font-weight: bold; color: #ecf0f1;"></p>
                <p id="finalTimeMessage" style="text-align: center; margin-bottom: 20px; font-weight: bold; color: #ecf0f1;"></p>
                <button class="action-btn" onclick="retakeQuiz()">Retake This Quiz</button>
                <button class="action-btn" onclick="showQuizReview(activeQuizCategory, activeQuizTitle, currentQuizQuestions, userAnswers)" style="margin-left: 10px;">Review Answers</button>
                <button class="action-btn" onclick="showWelcomeSection()" style="margin-left: 10px;">Go to Home</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="confirmModalOverlay">
        <div class="modal-content">
            <h3>Confirm Submission</h3>
            <p>Are you sure you want to submit your answers? You won't be able to change them after submission.</p>
            <button id="confirmYesBtn">Yes, Submit</button>
            <button id="confirmNoBtn">No, Cancel</button>
        </div>
    </div>

    <!-- Hidden form for Netlify submissions -->
    <form name="quiz-results" netlify netlify-honeypot="bot-field" hidden>
        <input type="text" name="user-name">
        <input type="text" name="quiz-category">
        <input type="text" name="quiz-title">
        <input type="number" name="score">
        <input type="number" name="total-questions">
        <input type="text" name="time-taken">
        <textarea name="answers"></textarea>
    </form>

    <script>
        const quizData = {
            reading: {
                "semiconductorBasics": {
                    title: "Semiconductor Basics",
                    icon: "fas fa-microchip",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <h3>Semiconductor Basics</h3>
                        <p>The semiconductor industry plays a crucial role in powering today's technology, from smartphones to satellites. At the heart of this process is silicon, a widely used material due to its excellent electrical properties and abundance.<br>
                        <p><br>It all begins with a wafer, a thin slice of purified silicon that serves as the foundation for building circuits. This wafer is mounted on a substrate, providing mechanical support during the manufacturing process. Using a process called photolithography, engineers create patterns on the wafer's surface using a mask — a kind of stencil that allows light to transfer circuit designs onto the silicon.</p>
                        <p><br>After multiple layers and processes like etching and doping, the wafer is cut into tiny rectangular sections called dies. Each die contains a complete functional circuit. Once tested and verified, these dies are packaged and become what we call a chip — ready to be installed in electronic devices. A key measure of manufacturing success is the yield, which refers to the percentage of dies on a wafer that function correctly. Higher yields reduce costs and improve efficiency. </p>
                        <p><br>Another critical term in the industry is node, which describes the size of the smallest features in a chip, measured in nanometers. Smaller nodes generally mean faster, more power-efficient chips. From raw silicon to high-performance chips, the semiconductor manufacturing process is a remarkable blend of science, precision, and innovation.</p>
                    `,
                    multiple: [
                        { question: "What is a wafer?", options: ["A mechanical support layer", "A finished chip", "A mask used for patterns", "A thin slice of silicon"], correct: 3 },
                        { question: "What is the function of the substrate in semiconductor fabrication?", options: ["To store designs", "To provide mechanical support", "To perform etching", "To cool down the wafer"], correct: 1 },
                        { question: "What does 'yield' refer to?", options: ["% of functional dies per wafer", "Thickness of a wafer", "Number of chips", "Cost of chip"], correct: 0 },
                        { question: "Smaller nodes lead to:", options: ["Higher cost", "Larger chips", "Faster and more power-efficient chips", "Slower performance"], correct: 2 },
                        { question: "What does the node size represent in chip design?", options: ["Wafer diameter", "The smallest features in nanometers", "Mask Thickness", "Number of Layers"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "A _______ is a stencil used in photolithography to pattern circuits.", answer: "mask" },
                        { question: "Circuit sections cut from wafer are called _______ ", answer: "dies" },
                        { question: "Raw material used to make wafers is _______ ", answer: "silicon" }
                    ],
                    oneWord: [
                        { question: "What material is commonly used in the semiconductor industry due to its electrical properties and abundance?", answer: "silicon" },
                        { question: "The semiconductor _______ process is a remarkable blend of science, precision, and innovation.", answer: "manufacturing" },
                        { question: "Higher yield reduce costs and improve _______?", answer: "efficiency" },
                        { question: "Semiconductor manufacturing process begins with a _______.", answer: "wafer" }
                    ]
                },
                "circuit": {
                    title: "Circuit",
                    icon: "fas fa-bolt",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <h3>Introduction to Circuits</h3>
                        <p>An electric circuit is a closed loop through which electricity can flow. It typically consists of a power source, conductors (wires), and components that consume or control the electricity, such as resistors, capacitors, and switches.</p>
                        <p>There are two primary types of circuits: series circuits and parallel circuits. In a series circuit, components are connected end-to-end, forming a single path for the current. This means the current is the same through each component, but the voltage drops across each. If one component breaks, the entire circuit is interrupted.</p>
                        <p>In a parallel circuit, components are connected across the same two points, creating multiple paths for the current. The voltage across each component is the same, but the current divides among the branches. If one component in a parallel circuit breaks, current can still flow through the other branches.</p>
                    `,
                    multiple: [
                        { question: "What is not typically a component of an electric circuit?", options: ["Insulator", "Conductor", "Load", "Power source"], correct: 0 },
                        { question: "In a series circuit, if one light bulb burns out:", options: ["The other bulbs get brighter", "The other bulbs remain lit", "All other bulbs go out", "The circuit becomes a parallel circuit"], correct: 2 },
                        { question: "Which type of circuit has multiple paths for current?", options: ["Series circuit", "Parallel circuit", "Short circuit", "Open circuit"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "In a series circuit, the current is the same _______.", answer: "everywhere" },
                        { question: "A _______ allows current to flow.", answer: "conductor" }
                    ],
                    oneWord: [
                        { question: "What is the unit of electrical resistance?", answer: "ohm" },
                        { question: "What component stores electrical energy in an electric field?", answer: "capacitor" }
                    ]
                },
                "layout": {
                    title: "Layout",
                    icon: "fas fa-layer-group",
                    difficulty: "moderate",
                    timeLimit: 10,
                    article: `
                        <h3>Semiconductor Layout Design</h3>
                        <p>Semiconductor layout design is the process of physically arranging the components of an integrated circuit (IC) onto a silicon chip. This involves placing transistors, resistors, capacitors, and interconnections (wires) in a way that meets performance, power, and area requirements.</p>
                        <p>Layout design is a crucial step after the logical design (schematic) is complete. It directly impacts the final chip's speed, power consumption, and manufacturing cost. Engineers use specialized Electronic Design Automation (EDA) tools to create and verify these layouts.</p>
                        <p>Key considerations in layout include minimizing wire lengths to reduce resistance and capacitance, preventing signal interference, and ensuring sufficient spacing between components to avoid electrical shorts. The layout must strictly adhere to design rules (DRC) specific to the fabrication process.</p>
                    `,
                    multiple: [
                        { question: "What is the primary purpose of semiconductor layout design?", options: ["To create a logical diagram of a circuit", "To physically arrange components on a silicon chip", "To simulate circuit behavior", "To test the final chip's functionality"], correct: 1 },
                        { question: "Which of the following is NOT typically placed during layout design?", options: ["Transistors", "Resistors", "Software algorithms", "Interconnections"], correct: 2 },
                        { question: "What aspect of the chip is directly impacted by layout design?", options: ["Marketing strategy", "Operating system version", "Manufacturing cost", "User interface"], correct: 2 },
                        { question: "What tools do engineers use to create and verify layouts?", options: ["Mechanical drafting tools", "Electronic Design Automation (EDA) tools", "Chemical etching solutions", "Manual assembly tools"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "Layout design is a crucial step after the _______ design is complete.", answer: "logical" },
                        { question: "Minimizing _______ lengths helps reduce resistance and capacitance in a layout.", answer: "wire" },
                        { question: "Layouts must strictly adhere to _______ rules specific to the fabrication process.", answer: "design" }
                    ],
                    oneWord: [
                        { question: "What type of circuit is laid out on a silicon chip?", answer: "integrated" },
                        { question: "What is the acronym for Electronic Design Automation tools?", answer: "EDA" },
                        { question: "What must be avoided between components by ensuring sufficient spacing?", answer: "shorts" }
                    ]
                },
                "circuitVerification": {
                    title: "Circuit Verification",
                    icon: "fas fa-check-circle",
                    difficulty: "moderate",
                    timeLimit: 10,
                    article: `
                        <h3>Circuit Verification Process</h3>
                        <p>Circuit verification ensures that the designed electronic circuit behaves as intended before it is fabricated. This critical step involves simulating the circuit's behavior under various conditions and comparing the results against the design specifications.</p>
                        <p>Common verification techniques include functional verification, which checks if the circuit performs its intended logic, and timing verification, which analyzes delays and ensures that signals arrive within specified time windows. Power verification assesses power consumption and thermal performance.</p>
                        <p>Engineers use a variety of simulation tools, such as SPICE for analog circuits and logic simulators for digital circuits. Formal verification methods, based on mathematical proofs, are also employed for highly critical components to guarantee correctness.</p>
                    `,
                    multiple: [
                        { question: "What is the primary goal of circuit verification?", options: ["To fabricate the circuit faster", "To ensure the circuit behaves as intended", "To reduce the cost of manufacturing", "To increase the circuit's physical size"], correct: 1 },
                        { question: "Which verification technique checks if the circuit performs its intended logic?", options: ["Timing verification", "Power verification", "Functional verification", "Thermal verification"], correct: 2 },
                        { question: "What kind of circuits is SPICE typically used for simulation?", options: ["Digital circuits", "Optical circuits", "Analog circuits", "Quantum circuits"], correct: 2 }
                    ],
                    fillBlank: [
                        { question: "Circuit verification involves _______ the circuit's behavior.", answer: "simulating" },
                        { question: "_______ verification analyzes delays and ensures signals arrive within specified time windows.", answer: "Timing" },
                        { question: "Formal verification methods are based on mathematical _______.", answer: "proofs" }
                    ],
                    oneWord: [
                        { question: "What kind of simulators are used for digital circuits?", answer: "logic" },
                        { question: "What is the term for assessing power consumption and thermal performance?", answer: "power" }
                    ]
                },
                "layoutVerification": {
                    title: "Layout Verification",
                    icon: "fas fa-cogs",
                    difficulty: "difficult",
                    timeLimit: 15,
                    article: `
                        <h3>Layout Verification Challenges</h3>
                        <p>Layout verification is a crucial step in integrated circuit design, ensuring that the physical layout accurately represents the intended schematic and adheres to manufacturing rules. As chip designs become more complex and feature sizes shrink, verification challenges escalate significantly.</p>
                        <p>Design Rule Checking (DRC) is fundamental, checking for geometric violations like minimum width, spacing, and overlap requirements. Layout Versus Schematic (LVS) compares the extracted circuit from the layout against the original schematic, verifying connectivity and component matching.</p>
                        <p>Parasitic Extraction (PEX) is another vital step, quantifying parasitic resistances, capacitances, and inductances introduced by interconnections and devices. These parasitics can significantly impact circuit performance and must be accurately modeled for post-layout simulation.</p>
                        <p>Advanced verification techniques include Electrical Rule Checking (ERC) for electrical integrity issues (e.g., floating nodes, shorted supplies) and Antenna Rule Checking (ARC) to prevent damage to gate oxides during fabrication. The sheer volume of data and the need for high accuracy make modern layout verification computationally intensive and a significant bottleneck in the design flow.</p>
                    `,
                    multiple: [
                        { question: "Which of the following is NOT a primary purpose of layout verification?", options: ["To ensure physical layout matches schematic", "To adhere to manufacturing rules", "To simulate circuit behavior before layout", "To quantify parasitic elements"], correct: 2 },
                        { question: "What does DRC primarily check for?", options: ["Electrical integrity issues", "Timing delays", "Geometric violations", "Component matching"], correct: 2 },
                        { question: "What is the purpose of LVS?", options: ["To extract parasitic resistances", "To compare layout to schematic", "To check antenna rules", "To identify floating nodes"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "PEX quantifies parasitic _______, capacitances, and inductances.", answer: "resistances" },
                        { question: "ARC helps prevent damage to _______ oxides during fabrication.", answer: "gate" },
                        { question: "Modern layout verification is computationally _______.", answer: "intensive" }
                    ],
                    oneWord: [
                        { question: "What type of circuit is laid out on a silicon chip?", answer: "integrated" },
                        { question: "What is the acronym for Electronic Design Automation tools?", answer: "EDA" },
                        { question: "What must be avoided between components by ensuring sufficient spacing?", answer: "shorts" }
                    ]
                }
            },
            grammar: {
                "BeforeWeBegin": {
                    title: "Before We Begin",
                    icon: "fas fa-spell-check",
                    difficulty: "easy",
                    timeLimit: 8,
                    article: `
                        <h3><i>Please read the instructions below and answer the following questions. 
                            <br>The answers are inside the Instructions so, please read them carefully.</i></h3> 
                        <p><br><h2>1. Please refrain from speaking in Japanese during this class.</h2></p>
                        <p>I will speak only in English during class whenever possible.</p> 
                        <p>However, I may occasionally use Japanese to clarify something if needed (just a word or two). If I do slip into Japanese, 
                        please feel free to remind me.</p>
                        <p><h2>2. Please do not hesitate to speak, even if you make mistakes</h2></p>
                        <p>Please do not hesitate to speak, ask questions or share your opinions. Speaking up and asking questions will help improve your spoken English.
                            I'm here to help you identify your mistakes and carefully correct them.</p>
                        <p><h2>3. Audio and Visual aid</h2></p>
                        <p>We will be using Audio and Video in the class to aid with the learning process. </p>
                        <p><h2>4. Quiz to enhance learning</h2></p>
                        <p>I will create quizzes in HTML for each class and continue adding more over time to check your understanding. 
                            However, please be aware that HTML-based quizzes offer very little protection—you can easily view the source code to find answers. 
                            So, I'm counting on you to be honest.</p>
                    `,
                    multiple: [
                        { question: "what should you avoid doing during the class?", options: ["avoid speaking in English", "avoid speaking in German", "avoid speaking in Japanese", "avoid speaking in Nepali"], correct: 2 },
                        { question: "Why does the presenter occasionally use Japanese?", options: ["to make the class interesting", "to clarify something", "to understand", "to make a joke"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "Please do not  _______ (hesitate/hesitated/hesitating) to speak, even if you make mistakes.", answer: "hesitate" },
                        { question: "HTML-based quizzes offer very little _______ .", answer: "protection" },
                        { question: "We will be using Audio and Video to _______ with the learning process. ", answer: "aid" }
                    ],
                    oneWord: [
                        { question: "Speaking up and asking questions will help (improve/improved/improving) your spoken English ", answer: "improve" }
                    ]
                },
                "Greetings": {
                    title: "Greetings",
                    icon: "fas fa-handshake",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <p> <i>Please answer the following by reviewing the Presentation titled <b>[Greetings]</b>.</i></p>
                        <h3>Common English Greetings</h3>
                    `,
                    multiple: [
                        { question: "Meaning of <b>casual</b> is?", options: ["Relaxed", "Serious", "Having attitude", "None of above"], correct: 0 },
                        { question: "What is an informal/casual greeting?", options: ["Hello", "Good morning", "Hey, what's up?", "Pleased to meet you"], correct: 2 },
                        { question: "What is an formal greeting?", options: ["Hello", "Good morning", "Good evening?", "All of above", "None of above"], correct: 3 }
                    ],
                    fillBlank: [
                        { question: "The appropraiate greeting that is suitable in the midle of day is _______ .", answer: "Good afternoon" },
                        { question: "When meeting someone for the first time, you might say 'Nice to meet _______'.", answer: "you" }
                    ],
                    oneWord: [
                        { question: "What greeting is used in the morning?", answer: "Good morning" },
                        { question: "You greet you friend using (formal/informal) greeting. eg Hey!?", answer: "informal" }
                    ]
                },
                "Appreciation_and_Name": {
                    title: "Appreciation and Name",
                    icon: "fas fa-handshake",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <p> <i>Please answer the following by reviewing the Presentation titled<b>[Appreciation and Name]</b>.</i></p>
                    `,
                    multiple: [
                        { question: "Which sentence shows polite appreciation?", options: ["I am glad.", "Thank you for taking the time to meet with us.", "My name is John Miller.", "I'm working now."], correct: 1 },
                        { question: "Which sentence uses a contraction?", options: ["I am grateful to you.", "Thank you for your time.","I'm glad to meet you.", "My name is Jennifer Smith.", "Pleased to meet you"], correct: 2 },
                        { question: "Which phrase introduces your full name most formally?", options: ["I'm John.", "John Miller here.", "Sup, I'm John.", "All of above", "None of above"], correct: 4 }
                    ],
                    fillBlank: [
                        { question: "I'm _______ to work with you. ", answer: "glad" },
                        { question: "_______ you for taking the time to meet with us.", answer: "thank" }
                    ],
                    oneWord: [
                        { question: "A polite word that means <b><i>thankful</i></b>", answer: "grateful" },
                        { question: "My _______ is Jennifer Smith", answer: "name" }
                    ]
                },
                "lplace": {
                    title: "Place",
                    icon: "fas fa-handshake",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <p> <i>Please answer the following by reviewing the Presentation titled <b>[Place]</b>.</i></p>
                    `,
                    multiple: [
                        { question: "Which sentence best fits a professional setting", options: ["I grew up in Canada.", "My home is in Kyoto.", "I'm based in Tokyo.", "I come from Brazil."], correct: 2 },
                        { question: "Which sentence shows current residence?", options: ["I'm from Mexico.", "I live in Sapporo.","I come from India.", "My hometown is Osaka.", "None of above"], correct: 1 },  
                        { question: "What sentence shows someone lived in a place for a long time?", options: ["I'm based in Nagoya.", "I've lived in Fukuoka for 12 years.", "I live in Sendai.", "All of above", "None of above"], correct: 1 },
                    ],
                    fillBlank: [
                        { question: "I ______ up in Okinawa. ", answer: "grew" },
                        { question: "My _______ is Yokohama.", answer: "hometown" },
                        { question: "I have ______ in Kumamoto for 8 years.", answer: "lived"  },
                    ],
                    oneWord: [
                        { question: "Right now, I ______ in Kyoto.", answer: "live" },
                        { question: "I am from Italy, but I'm currently ______ in Kobe for my studies.", answer: "settled" }
                    ]
                },
                "job": {
                    title: "Job",
                    icon: "fas fa-handshake",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <p> <i>Please answer the following by reviewing the Presentation titled <b>[Work/Job]</b>.</i></p>
                    `,
                    multiple: [
                        { question: "I am an engineer. What is my job?", options: ["Doctor", "Teacher", "Engineer", "Artist"], correct: 2 },
                        { question: "I work as an engineer. What do I do?", options: ["Cook Food", "Paint","Sing songs", "All of above", "None of above"], correct: 4 },  
                        { question: "I help build/design/fix things. Who am I?", options: ["Doctor", "Engineer", "carpenter", "All of above", "None of above"], correct: 1 },
                    ],
                    fillBlank: [
                        { question: "I have been ______ as an engineer for 10 years. ", answer: "working" },
                        { question: "I design electronic circuits. I am a _______ design engineer", answer: "circuit" },
                        { question: "I am ______ by profession", answer: "an engineer"  },
                    ],
                    oneWord: [
                        { question: "Engineers build/ ______ /fix things", answer: "design" },
                        { question: "What is my field if I design chip layout", answer: "layout engineer" }
                    ]
                },
                "ending": {
                    title: "Ending Emails/Meeting/Introduction",
                    icon: "fas fa-handshake",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <p> <i>Please answer the following by reviewing the Presentation titled <b>[Ending Emails, Introduction or Meeting]</b>.</i></p>
                    `,
                    multiple: [
                        { question: "Which sentence expresses gratitude in a professional tone?", options: ["I'm glad to be working with you.", "I appreciate the opportunity to work with you.", "Happy to be working with you.", "Nice to be on the same team!"], correct: 1 },
                        { question: "Which of these is a casual way to end a meeting?", options: ["Looking forward to a successful partnership.", "I'm eager to work together and achieve great results.","It's a pleasure to work with you.", "Can't wait to work together!"], correct: 3 },  
                        { question: "Which of the following is a professional way to end an email?", options: ["Can't wait to work together!", "Nice to be on the same team!", "I'm looking forward to collaborating with you.","Excited to get started with you."], correct: 2 },
                    ],
                    fillBlank: [
                        { question: "I am ______ to a successful partnership. ", answer: "looking forward" },
                        { question: "Nice to be on the same ________.", answer: "team" },
                        { question: "What is the tone in 'Can't wait to work together!'", answer: "casual"  },
                    ],
                    oneWord: [
                        { question: "I am glad to be ______ (work/worked/working) with you", answer: "working" },
                        { question: "Nice to be on the same team. This is a used in ______ (polite, rude, friendly) situation ", answer: "friendly" }
                    ]
                }
            },
            vocabulary: {
                "advancedEnglish": {
                    title: "Advanced English",
                    icon: "fas fa-language",
                    difficulty: "moderate",
                    timeLimit: 7,
                    article: `
                        <h3>Expanding Your Vocabulary</h3>
                        <p>To truly master English, expanding your vocabulary beyond common words is essential. Understanding nuances and context will help you communicate more precisely and effectively.</p>
                        <p>For example, instead of just "big," consider "colossal," "immense," or "gargantuan" depending on the scale. Instead of "happy," you might use "jubilant," "elated," or "euphoric" to convey different intensities of joy.</p>
                        <p>Reading widely, using a thesaurus, and actively trying to incorporate new words into your speaking and writing are excellent strategies for vocabulary expansion.</p>
                    `,
                    multiple: [
                        { question: "Which word means 'extremely large'?", options: ["Tiny", "Modest", "Colossal", "Small"], correct: 2 },
                        { question: "If someone is 'euphoric', how are they feeling?", options: ["Sad", "Angry", "Extremely happy", "Confused"], correct: 2 }
                    ],
                    fillBlank: [
                        { question: "Understanding _______ and context helps precise communication.", answer: "nuances" },
                        { question: "A _______ can help you find synonyms.", answer: "thesaurus" }
                    ],
                    oneWord: [
                        { question: "What is an alternative to 'happy' indicating great joy?", answer: "jubilant" },
                        { question: "What helps with vocabulary expansion?", answer: "reading" }
                    ]
                }
            },
            listening: {
                "semiconductorDevices": {
                    title: "Semiconductor Devices",
                    icon: "fas fa-headphones",
                    difficulty: "easy",
                    timeLimit: 5,
                    article: `
                        <h3>Listening Comprehension: Semiconductor Devices</h3>
                        <p>In this listening exercise, you will hear a short audio about common semiconductor devices. Pay attention to the details and main ideas.</p>
                        <audio controls>
                            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
                            Your browser does not support the audio element.
                        </audio>
                        <p style="margin-top: 15px;">After listening, answer the questions below based on the audio content.</p>
                    `,
                    multiple: [
                        { question: "According to the audio, which device is primarily used for amplification?", options: ["Diode", "Resistor", "Transistor", "Capacitor"], correct: 2 },
                        { question: "What is a common application mentioned for diodes?", options: ["Storing energy", "Rectifying AC to DC", "Amplifying signals", "Controlling current flow"], correct: 1 }
                    ],
                    fillBlank: [
                        { question: "The audio discusses common _______ devices.", answer: "semiconductor" },
                        { question: "A _______ allows current to flow in one direction.", answer: "diode" }
                    ],
                    oneWord: [
                        { question: "What is the process of converting AC to DC?", answer: "Rectification" },
                        { question: "What device acts like an electronic switch?", answer: "transistor" }
                    ]
                }
            }
        };

        let userData = {
            name: "Guest",
            quizzes: {},
            adminLoggedIn: false
        };

        let activeQuizCategory = null;
        let activeQuizTitle = null;
        let timerInterval;
        let quizStartTime;
        let currentQuizQuestions = [];
        let userAnswers = [];
        let serverResults = [];

        function loadUserData() {
            const savedUserData = localStorage.getItem('currentUser');
            if (savedUserData) {
                userData.name = JSON.parse(savedUserData).name;
                document.getElementById('displayName').textContent = userData.name;
                document.getElementById('introUserName').textContent = userData.name;
            } else {
                userData.name = "Guest";
                document.getElementById('welcomeUserName').value = ''; 
            }
            
            // Load quiz data from localStorage
            const userKey = `user_${userData.name}`;
            const savedQuizData = localStorage.getItem(userKey);
            if (savedQuizData) {
                userData.quizzes[userData.name] = JSON.parse(savedQuizData);
            }
            
            updateScoreDisplay();
        }

        function saveUserData() {
            localStorage.setItem('currentUser', JSON.stringify({ name: userData.name }));
            
            if (userData.name !== "Guest" && activeQuizCategory && activeQuizTitle) {
                const userKey = `user_${userData.name}`;
                if (!userData.quizzes[userData.name]) {
                    userData.quizzes[userData.name] = {};
                }
                userData.quizzes[userData.name][`${activeQuizCategory}_${activeQuizTitle}`] = {
                    ...(userData.quizzes[userData.name][`${activeQuizCategory}_${activeQuizTitle}`] || {}),
                    answers: userAnswers,
                };
                localStorage.setItem(userKey, JSON.stringify(userData.quizzes[userData.name]));
            }
        }
        
        function showSection(sectionId) {
            document.querySelectorAll('.quiz-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            const contentHeader = document.querySelector('.content-header');
            const quizTimer = document.getElementById('quizTimer');
            const quizTimeTaken = document.getElementById('quizTimeTaken');
            const sidebar = document.querySelector('.sidebar');

            if (sectionId === 'quizSection') {
                contentHeader.style.display = 'flex';
                quizTimer.style.display = 'block';
                quizTimeTaken.style.display = 'none';
                sidebar.classList.remove('hidden');
            } else if (sectionId === 'welcomeSection') {
                contentHeader.style.display = 'none';
                quizTimer.style.display = 'none';
                quizTimeTaken.style.display = 'none';
                sidebar.classList.remove('hidden');
            } else if (sectionId === 'adminLoginSection' || sectionId === 'adminDashboardSection') {
                contentHeader.style.display = 'flex';
                quizTimer.style.display = 'none';
                quizTimeTaken.style.display = 'none';
                sidebar.classList.add('hidden');
            }
            else {
                contentHeader.style.display = 'flex';
                quizTimer.style.display = 'none';
                quizTimeTaken.style.display = 'none';
                sidebar.classList.remove('hidden');
            }
        }

        function updateScoreDisplay() {
            let totalScore = 0;
            let totalQuestions = 0;

            if (userData.quizzes[userData.name]) {
                for (const quizKey in userData.quizzes[userData.name]) {
                    const quizResult = userData.quizzes[userData.name][quizKey];
                    if (typeof quizResult.score === 'number' && typeof quizResult.total === 'number') {
                        totalScore += quizResult.score;
                        totalQuestions += quizResult.total;
                    }
                }
            }
            document.getElementById('scoreDisplay').textContent = `Score: ${totalScore}/${totalQuestions}`;
        }

        function startTimer(timeLimitMinutes) {
            stopTimer();
            let totalSeconds = timeLimitMinutes * 60;
            quizStartTime = Date.now();

            timerInterval = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - quizStartTime) / 1000);
                const remainingSeconds = totalSeconds - elapsedSeconds;

                if (remainingSeconds <= 0) {
                    stopTimer();
                    updateTimerDisplay(0);
                    alert("Time's up! Your quiz has been submitted automatically.");
                    submitCurrentQuizAnswers();
                    return;
                }
                updateTimerDisplay(remainingSeconds);
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function updateTimerDisplay(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('quizTimer').textContent = `Time: ${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function getFormattedTime(milliseconds) {
            const totalSeconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function toggleSubMenu(category) {
            const subMenu = document.getElementById(`${category}SubMenu`);
            const navCategoryLink = subMenu.previousElementSibling;
            const caretIcon = navCategoryLink.querySelector('.fas.fa-caret-down, .fas.fa-caret-up');

            document.querySelectorAll('.quiz-sub-menu.show').forEach(openMenu => {
                if (openMenu.id !== `${category}SubMenu`) {
                    openMenu.classList.remove('show');
                    const openCaret = openMenu.previousElementSibling.querySelector('.fas.fa-caret-up');
                    if (openCaret) {
                        openCaret.classList.remove('fa-caret-up');
                        openCaret.classList.add('fa-caret-down');
                    }
                }
            });

            subMenu.classList.toggle('show');
            if (subMenu.classList.contains('show')) {
                caretIcon.classList.remove('fa-caret-down');
                caretIcon.classList.add('fa-caret-up');
            } else {
                caretIcon.classList.remove('fa-caret-up');
                caretIcon.classList.add('fa-caret-down');
            }
        }

        function loadQuiz(category, title, element) {
            if (userData.name === "Guest") {
                alert("Please enter your name to start a quiz!");
                showWelcomeSection();
                return;
            }

            document.querySelectorAll('.quiz-sub-menu a.active').forEach(link => {
                link.classList.remove('active');
            });
            element.classList.add('active');

            activeQuizCategory = category;
            activeQuizTitle = title;
            const quiz = quizData[category][title];

            document.getElementById('currentQuizTitle').textContent = quiz.title;
            document.getElementById('currentQuizArticle').innerHTML = quiz.article || '';
            
            currentQuizQuestions = [];
            if (quiz.multiple) currentQuizQuestions = currentQuizQuestions.concat(quiz.multiple.map((q, i) => ({ type: 'multiple', ...q, originalIndex: i })));
            if (quiz.fillBlank) currentQuizQuestions = currentQuizQuestions.concat(quiz.fillBlank.map((q, i) => ({ type: 'fillBlank', ...q, originalIndex: i })));
            if (quiz.oneWord) currentQuizQuestions = currentQuizQuestions.concat(quiz.oneWord.map((q, i) => ({ type: 'oneWord', ...q, originalIndex: i })));

            currentQuizQuestions.sort(() => Math.random() - 0.5);
            
            // Check if there are saved answers for this quiz
            const quizKey = `${activeQuizCategory}_${activeQuizTitle}`;
            if (userData.quizzes[userData.name] && userData.quizzes[userData.name][quizKey] && userData.quizzes[userData.name][quizKey].answers) {
                userAnswers = [...userData.quizzes[userData.name][quizKey].answers];
            } else {
                userAnswers = new Array(currentQuizQuestions.length).fill(null);
            }
            
            displayQuiz();
            startTimer(quiz.timeLimit);
            showSection('quizSection');
            document.getElementById('quizProgressBarContainer').style.display = 'block';
            document.getElementById('currentQuizSubmitBtn').style.display = 'block';
            document.getElementById('retakeQuizBtn').style.display = 'none';
            document.getElementById('reviewQuizBtn').style.display = 'none';
            updateProgressBar();
        }

        function displayQuiz() {
            const questionsContainer = document.getElementById('currentQuizQuestions');
            questionsContainer.innerHTML = '';

            currentQuizQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.classList.add('question');
                questionDiv.dataset.questionIndex = index;

                let questionHtml = `
                    <div class="question-header">
                        Question ${index + 1}: <span class="question-type">${q.type === 'multiple' ? 'Multiple Choice' : q.type === 'fillBlank' ? 'Fill in the Blank' : 'One Word Answer'}</span>
                    </div>
                    <p>${q.question}</p>
                `;

                if (q.type === 'multiple') {
                    questionHtml += `<div class="mcq-options">`;
                    q.options.forEach((option, optionIndex) => {
                        const isSelected = userAnswers[index] === optionIndex;
                        questionHtml += `
                            <label class="mcq-option ${isSelected ? 'selected' : ''}" data-option-index="${optionIndex}">
                                <input type="radio" name="question${index}" value="${optionIndex}" ${isSelected ? 'checked' : ''} onchange="handleMCQSelection(${index}, this.value)">
                                <span>${option}</span>
                            </label>
                        `;
                    });
                    questionHtml += `</div>`;
                } else if (q.type === 'fillBlank' || q.type === 'oneWord') {
                    const userAnswer = userAnswers[index] !== null ? userAnswers[index] : '';
                    questionHtml += `
                        <input type="text" class="${q.type}-input" placeholder="Your answer" value="${userAnswer}" oninput="handleInputAnswer(${index}, this.value)">
                    `;
                }
                questionHtml += `<div class="feedback-message" id="feedback-q${index}"></div>`;

                questionDiv.innerHTML = questionHtml;
                questionsContainer.appendChild(questionDiv);
            });
        }

        function handleMCQSelection(questionIndex, optionIndex) {
            userAnswers[questionIndex] = parseInt(optionIndex);
            saveUserData();
            updateProgressBar();

            const questionElement = document.querySelector(`.question[data-question-index="${questionIndex}"]`);
            questionElement.querySelectorAll('.mcq-option').forEach((optionLabel, idx) => {
                if (idx === parseInt(optionIndex)) {
                    optionLabel.classList.add('selected');
                } else {
                    optionLabel.classList.remove('selected');
                }
            });
        }

        function handleInputAnswer(questionIndex, value) {
            userAnswers[questionIndex] = value;
            saveUserData();
            updateProgressBar();
        }

        function updateProgressBar() {
            const answeredCount = userAnswers.filter(answer => answer !== null && answer !== '').length;
            const totalQuestions = currentQuizQuestions.length;
            const percentage = totalQuestions > 0 ? (answeredCount / totalQuestions) * 100 : 0;
            
            const progressBar = document.getElementById('quizProgressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${Math.round(percentage)}% Completed`;
        }
        
        function confirmSubmission() {
            document.getElementById('confirmModalOverlay').style.visibility = 'visible';
            document.getElementById('confirmModalOverlay').style.opacity = '1';
            document.getElementById('confirmYesBtn').onclick = submitCurrentQuizAnswers;
            document.getElementById('confirmNoBtn').onclick = closeModal;
        }

        function closeModal() {
            document.getElementById('confirmModalOverlay').style.visibility = 'hidden';
            document.getElementById('confirmModalOverlay').style.opacity = '0';
        }

        function submitCurrentQuizAnswers() {
            closeModal();
            stopTimer();

            const quizScore = calculateScore();
            const totalQuestions = currentQuizQuestions.length;
            const timeTakenMs = Date.now() - quizStartTime;
            const formattedTime = getFormattedTime(timeTakenMs);

            // Apply feedback to questions
            currentQuizQuestions.forEach((q, index) => {
                const questionElement = document.querySelector(`.question[data-question-index="${index}"]`);
                const userAnswer = userAnswers[index];
                let isCorrect = false;
                const feedbackDiv = questionElement.querySelector(`#feedback-q${index}`);
                feedbackDiv.classList.add('show-feedback');

                if (q.type === 'multiple') {
                    isCorrect = (userAnswer === q.correct);
                    const options = questionElement.querySelectorAll('.mcq-option');
                    options.forEach((optionLabel, optionIndex) => {
                        const radioInput = optionLabel.querySelector('input[type="radio"]');
                        radioInput.disabled = true;
                        optionLabel.style.pointerEvents = 'none';

                        if (optionIndex === q.correct) {
                            optionLabel.classList.add('correct-highlight-feedback');
                        }
                        if (optionIndex === userAnswer) {
                            optionLabel.classList.remove('selected');
                            if (isCorrect) {
                                optionLabel.classList.add('correct-answer-feedback');
                                feedbackDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correct!`;
                                feedbackDiv.classList.add('correct');
                            } else {
                                optionLabel.classList.add('incorrect-answer-feedback');
                                feedbackDiv.innerHTML = `<i class="fas fa-times-circle"></i> Incorrect. Correct: ${q.options[q.correct]}`;
                                feedbackDiv.classList.add('incorrect');
                            }
                        }
                    });
                } else if (q.type === 'fillBlank' || q.type === 'oneWord') {
                    isCorrect = (userAnswer && userAnswer.trim().toLowerCase() === q.answer.toLowerCase());
                    const inputField = questionElement.querySelector(`.${q.type}-input`);
                    inputField.disabled = true;

                    if (isCorrect) {
                        inputField.classList.add('correct-feedback');
                        feedbackDiv.innerHTML = `<i class="fas fa-check-circle"></i> Correct!`;
                        feedbackDiv.classList.add('correct');
                    } else {
                        inputField.classList.add('incorrect-feedback');
                        feedbackDiv.innerHTML = `<i class="fas fa-times-circle"></i> Incorrect. Correct: ${q.answer}`;
                        feedbackDiv.classList.add('incorrect');
                    }
                }
            });

            // Save results locally
            const quizKey = `${activeQuizCategory}_${activeQuizTitle}`;
            if (!userData.quizzes[userData.name]) {
                userData.quizzes[userData.name] = {};
            }
            userData.quizzes[userData.name][quizKey] = {
                answers: userAnswers,
                questions: currentQuizQuestions,
                score: quizScore,
                total: totalQuestions,
                timeTaken: formattedTime
            };
            saveUserData();
            updateScoreDisplay();

            // Submit results to Netlify
            submitResultsToServer(userData.name, activeQuizCategory, activeQuizTitle, quizScore, totalQuestions, formattedTime, userAnswers);

            // Update UI
            document.getElementById('finalScoreMessage').textContent = `You scored: ${quizScore}/${totalQuestions}`;
            document.getElementById('finalTimeMessage').textContent = `Time taken: ${formattedTime}`;
            
            document.getElementById('quizProgressBarContainer').style.display = 'none'; 
            document.getElementById('currentQuizSubmitBtn').style.display = 'none'; 
            document.getElementById('retakeQuizBtn').style.display = 'inline-block'; 
            document.getElementById('reviewQuizBtn').style.display = 'inline-block'; 
            
            document.getElementById('quizTimer').style.display = 'none';
            document.getElementById('quizTimeTaken').textContent = `Time Taken: ${formattedTime}`;
            document.getElementById('quizTimeTaken').style.display = 'block';
        }

function submitResultsToServer(userName, category, title, score, total, timeTaken, answers) {
  // Submit to Netlify function
  fetch('/.netlify/functions/submitResult', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      userName: userName,
      category: category,
      title: title,
      score: score,
      total: total,
      timeTaken: timeTaken,
      answers: answers
    })
  })
  .then(response => {
    if (!response.ok) {
      console.error('Failed to submit results to server');
    }
  })
  .catch(error => {
    console.error('Error submitting results:', error);
  });
}

        function calculateScore() {
            let score = 0;
            currentQuizQuestions.forEach((q, index) => {
                const userAnswer = userAnswers[index];
                if (userAnswer === null || userAnswer === undefined || (typeof userAnswer === 'string' && userAnswer.trim() === '')) {
                    return;
                }

                if (q.type === 'multiple') {
                    if (userAnswer === q.correct) {
                        score++;
                    }
                } else if (q.type === 'fillBlank' || q.type === 'oneWord') {
                    if (userAnswer.trim().toLowerCase() === q.answer.toLowerCase()) {
                        score++;
                    }
                }
            });
            return score;
        }

        function showQuizReview(category, title, questionsToReview, userAnswersForReview) {
            const reviewQuestionsContainer = document.getElementById('reviewQuestionsContainer');
            reviewQuestionsContainer.innerHTML = '';
            document.getElementById('reviewQuizTitle').textContent = `Review: ${quizData[category][title].title}`;

            questionsToReview.forEach((q, index) => {
                const reviewItem = document.createElement('div');
                reviewItem.classList.add('review-item');

                const userAnswer = userAnswersForReview[index];
                let isCorrect = false;
                let userAnswerDisplay = '';
                let correctAnswerDisplay = '';

                if (q.type === 'multiple') {
                    isCorrect = (userAnswer === q.correct);
                    userAnswerDisplay = userAnswer !== null ? q.options[userAnswer] : 'No answer given';
                    correctAnswerDisplay = q.options[q.correct];
                } else if (q.type === 'fillBlank' || q.type === 'oneWord') {
                    isCorrect = (userAnswer && typeof userAnswer === 'string' && userAnswer.trim().toLowerCase() === q.answer.toLowerCase());
                    userAnswerDisplay = userAnswer && userAnswer.trim() !== '' ? userAnswer : 'No answer given';
                    correctAnswerDisplay = q.answer;
                }

                reviewItem.innerHTML = `
                    <div class="review-question-header">
                        Question ${index + 1}: <span class="question-type">${q.type === 'multiple' ? 'Multiple Choice' : q.type === 'fillBlank' ? 'Fill in the Blank' : 'One Word Answer'}</span>
                    </div>
                    <p>${q.question}</p>
                    <div class="review-answer-info ${isCorrect ? 'correct' : 'incorrect'}">
                        <strong>Your Answer:</strong> <span>${userAnswerDisplay}</span>
                        ${!isCorrect ? `<strong>Correct Answer:</strong> <span>${correctAnswerDisplay}</span>` : ''}
                    </div>
                `;
                reviewQuestionsContainer.appendChild(reviewItem);
            });
            showSection('quizReviewSection');
        }

        function retakeQuiz() {
            userAnswers = new Array(currentQuizQuestions.length).fill(null);
            
            const quizKey = `${activeQuizCategory}_${activeQuizTitle}`;
            if (userData.quizzes[userData.name] && userData.quizzes[userData.name][quizKey]) {
                delete userData.quizzes[userData.name][quizKey];
            }
            saveUserData();
            updateScoreDisplay();

            const activeLinkElement = document.querySelector(`.quiz-sub-menu a[onclick*="loadQuiz('${activeQuizCategory}', '${activeQuizTitle}'"]`);
            loadQuiz(activeQuizCategory, activeQuizTitle, activeLinkElement);
        }

        function startQuiz() {
            const userNameInput = document.getElementById('welcomeUserName');
            const name = userNameInput.value.trim();
            if (name) {
                userData.name = name;
                document.getElementById('displayName').textContent = name;
                document.getElementById('introUserName').textContent = name;
                localStorage.setItem('currentUser', JSON.stringify({ name: userData.name }));
                showSection('introductionSection');
                document.querySelector('.content-header').style.display = 'flex';
            } else {
                alert("Please enter your name!");
            }
        }

        function proceedToQuiz() {
            showSection('quizSection');
            document.getElementById('currentQuizTitle').textContent = "Select a Quiz";
            document.getElementById('currentQuizArticle').innerHTML = "<p style='text-align: center; margin-top: 50px; color: #bdc3c7;'>Please choose a quiz from the sidebar to begin.</p>";
            document.getElementById('currentQuizQuestions').innerHTML = '';
            document.getElementById('quizProgressBarContainer').style.display = 'none';
            document.getElementById('currentQuizSubmitBtn').style.display = 'none';
            document.getElementById('retakeQuizBtn').style.display = 'none';
            document.getElementById('reviewQuizBtn').style.display = 'none';
            stopTimer();
            updateTimerDisplay(0);
        }

        function showWelcomeSection() {
            showSection('welcomeSection');
            stopTimer();
            updateTimerDisplay(0);
        }

        function showAdminLogin(element) {
            document.querySelectorAll('.quiz-sub-menu a.active').forEach(link => {
                link.classList.remove('active');
            });
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            showSection('adminLoginSection');
        }

        function adminLogin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            if (username === 'GplAdh' && password === 'LpgHda@$') {
                userData.adminLoggedIn = true;
                loadAdminDashboard();
                showSection('adminDashboardSection');
            } else {
                alert('Invalid admin credentials.');
            }
        }

        function adminLogout() {
            userData.adminLoggedIn = false;
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
            showWelcomeSection();
        }

        async function fetchServerResults() {
            try {
                const response = await fetch('/.netlify/functions/getResults');
                if (!response.ok) {
                    throw new Error('Failed to fetch results');
                }
                const data = await response.json();
                serverResults = data;
                return data;
            } catch (error) {
                console.error('Error fetching results:', error);
                return [];
            }
        }

        async function loadAdminDashboard() {
            // Fetch results from server first
            await fetchServerResults();
            
            document.getElementById('totalUsersStat').textContent = Object.keys(userData.quizzes).length;
            
            let totalQuizzesCompleted = 0;
            let totalCorrectAnswers = 0;
            let totalPossibleAnswers = 0;

            const adminResultsTableBody = document.getElementById('adminResultsTableBody');
            adminResultsTableBody.innerHTML = '';

            // Combine local and server results
            const allResults = [...serverResults];
            
            // Add local results that aren't already in server results
            for (const userName in userData.quizzes) {
                const userQuizzes = userData.quizzes[userName];
                for (const quizKey in userQuizzes) {
                    const quizResult = userData.quizzes[userName][quizKey];
                    const [category, title] = quizKey.split('_');
                    
                    // Check if this result already exists in server results
                    const existsInServer = serverResults.some(result => 
                        result['user-name'] === userName && 
                        result['quiz-category'] === category && 
                        result['quiz-title'] === title
                    );
                    
                    if (!existsInServer) {
                        allResults.push({
                            'user-name': userName,
                            'quiz-category': category,
                            'quiz-title': title,
                            'score': quizResult.score,
                            'total-questions': quizResult.total,
                            'time-taken': quizResult.timeTaken
                        });
                    }
                }
            }

            // Process all results (local + server)
            allResults.forEach(result => {
                const userName = result['user-name'];
                const category = result['quiz-category'];
                const title = result['quiz-title'];
                const score = result['score'];
                const total = result['total-questions'];
                const timeTaken = result['time-taken'];
                
                totalQuizzesCompleted++;
                totalCorrectAnswers += score;
                totalPossibleAnswers += total;

                const row = adminResultsTableBody.insertRow();
                row.insertCell().textContent = userName;
                row.insertCell().textContent = quizData[category] ? quizData[category][title].title : title;
                row.insertCell().textContent = title;
                row.insertCell().textContent = `${score}/${total}`;
                row.insertCell().textContent = timeTaken;

                const actionsCell = row.insertCell();
                
                const reviewButton = document.createElement('button');
                reviewButton.textContent = 'Review';
                reviewButton.classList.add('action-btn');
                reviewButton.style.backgroundColor = '#3498db';
                reviewButton.style.padding = '5px 10px';
                reviewButton.style.fontSize = '12px';
                reviewButton.style.marginRight = '5px';
                reviewButton.onclick = () => adminReviewQuiz(userName, category, title, result);
                actionsCell.appendChild(reviewButton);

                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.classList.add('action-btn');
                deleteButton.style.backgroundColor = '#e74c3c';
                deleteButton.style.padding = '5px 10px';
                deleteButton.style.fontSize = '12px';
                deleteButton.style.margin = '0';
                deleteButton.onclick = () => deleteUserQuizResult(userName, category, title);
                actionsCell.appendChild(deleteButton);
            });

            const averageScore = totalPossibleAnswers > 0 ? (totalCorrectAnswers / totalPossibleAnswers) * 100 : 0;
            document.getElementById('quizzesCompletedStat').textContent = totalQuizzesCompleted;
            document.getElementById('averageScoreStat').textContent = `${averageScore.toFixed(2)}%`;
        }

        function adminReviewQuiz(userName, category, title, result) {
            // Try to find the full quiz data in local storage first
            const quizKey = `${category}_${title}`;
            if (userData.quizzes[userName] && userData.quizzes[userName][quizKey]) {
                const quizResult = userData.quizzes[userName][quizKey];
                if (quizResult && quizResult.questions && quizResult.answers) {
                    showQuizReview(category, title, quizResult.questions, quizResult.answers);
                    return;
                }
            }
            
            // If not found locally, try to use the data from server results
            if (result && result.answers) {
                try {
                    const answers = JSON.parse(result.answers);
                    const questions = quizData[category][title] ? [
                        ...(quizData[category][title].multiple || []),
                        ...(quizData[category][title].fillBlank || []),
                        ...(quizData[category][title].oneWord || [])
                    ] : [];
                    
                    if (questions.length > 0) {
                        showQuizReview(category, title, questions, answers.map(a => {
                            if (a.userAnswer === 'No answer') return null;
                            if (a.userAnswer === 'No answer given') return null;
                            return a.userAnswer;
                        }));
                        return;
                    }
                } catch (e) {
                    console.error('Error parsing answers:', e);
                }
            }
            
            alert("Quiz data for review is incomplete or not found.");
        }

        async function deleteUserQuizResult(userName, category, title) {
            if (confirm(`Are you sure you want to delete the results for ${title} for user ${userName}?`)) {
                // Delete from local storage if exists
                const quizKey = `${category}_${title}`;
                if (userData.quizzes[userName]) {
                    delete userData.quizzes[userName][quizKey];
                    const userKey = `user_${userName}`;
                    localStorage.setItem(userKey, JSON.stringify(userData.quizzes[userName]));
                    if (Object.keys(userData.quizzes[userName]).length === 0) {
                        delete userData.quizzes[userName];
                        localStorage.removeItem(userKey);
                    }
                }
                
                // Delete from server if exists
                try {
                    const response = await fetch('/.netlify/functions/deleteResult', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            userName: userName,
                            category: category,
                            title: title
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to delete from server');
                    }
                } catch (error) {
                    console.error('Error deleting from server:', error);
                }
                
                loadAdminDashboard();
                updateScoreDisplay();
            }
        }

        async function clearUserData() {
            if (confirm("Are you sure you want to clear ALL user data? This action cannot be undone.")) {
                // Clear local storage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('user_')) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                const savedUserData = localStorage.getItem('currentUser');
                if (savedUserData) {
                    localStorage.setItem('currentUser', JSON.stringify({ name: "Guest" }));
                }

                userData = {
                    name: "Guest",
                    quizzes: {},
                    adminLoggedIn: false
                };
                
                // Clear server data
                try {
                    const response = await fetch('/.netlify/functions/clearResults', {
                        method: 'POST'
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to clear server data');
                    }
                } catch (error) {
                    console.error('Error clearing server data:', error);
                }
                
                loadUserData();
                showWelcomeSection();
                alert("All user data has been cleared.");
            }
        }

        async function exportData() {
            // Fetch latest results from server
            await fetchServerResults();
            
            const allQuizResults = [];
            
            // Process server results
            serverResults.forEach(result => {
                allQuizResults.push({
                    userName: result['user-name'],
                    quizCategory: result['quiz-category'],
                    quizTitle: quizData[result['quiz-category']] && quizData[result['quiz-category']][result['quiz-title']] ? 
                        quizData[result['quiz-category']][result['quiz-title']].title : result['quiz-title'],
                    score: result['score'],
                    totalQuestions: result['total-questions'],
                    timeTaken: result['time-taken']
                });
            });
            
            // Process local results that aren't in server results
            for (const userName in userData.quizzes) {
                const userQuizzes = userData.quizzes[userName];
                for (const quizKey in userQuizzes) {
                    const quizResult = userQuizzes[quizKey];
                    const [category, title] = quizKey.split('_');
                    
                    // Check if this result already exists in server results
                    const existsInServer = serverResults.some(result => 
                        result['user-name'] === userName && 
                        result['quiz-category'] === category && 
                        result['quiz-title'] === title
                    );
                    
                    if (!existsInServer) {
                        allQuizResults.push({
                            userName: userName,
                            quizCategory: category,
                            quizTitle: quizData[category] && quizData[category][title] ? quizData[category][title].title : title,
                            score: quizResult.score,
                            totalQuestions: quizResult.total,
                            timeTaken: quizResult.timeTaken
                        });
                    }
                }
            }
            
            generateCombinedCSV(allQuizResults);
        }

        function generateCombinedCSV(data) {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "User Name,Quiz Category,Quiz Title,Score,Total Questions,Time Taken\r\n";

            data.forEach(row => {
                let rowData = [
                    row.userName,
                    row.quizCategory,
                    row.quizTitle,
                    row.score,
                    row.totalQuestions,
                    row.timeTaken
                ].map(item => `"${String(item).replace(/"/g, '""')}"`).join(",");
                csvContent += rowData + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "all_quiz_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData();
            document.getElementById('currentQuizSubmitBtn').style.display = 'none';
            document.getElementById('quizProgressBarContainer').style.display = 'none';
            document.getElementById('quizTimeTaken').style.display = 'none';
        });
    </script>
</body>
</html>