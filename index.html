<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quiz System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Your existing CSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            color: #ecf0f1;
        }

        .sidebar {
            width: 250px;
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
            transform: translateX(0); /* Default: sidebar visible */
            z-index: 1000;
        }

        .sidebar.hidden {
            transform: translateX(-100%);
        }

        .toggle-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: left 0.3s ease-in-out;
        }

        .sidebar.hidden + .toggle-btn {
            left: 20px;
        }

        .sidebar:not(.hidden) + .toggle-btn {
            left: 270px; /* Adjust if sidebar width changes */
        }

        .logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo img {
            max-width: 80px;
            height: auto;
            border-radius: 50%;
            border: 3px solid #3498db;
        }

        .logo h2 {
            color: #3498db;
            margin-top: 10px;
            font-size: 1.5em;
        }

        .nav-links {
            list-style: none;
            padding: 0;
        }

        .nav-links li {
            margin-bottom: 15px;
        }

        .nav-links a {
            color: #ecf0f1;
            text-decoration: none;
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-radius: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .nav-links a i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .nav-links a:hover,
        .nav-links a.active {
            background-color: #3498db;
            color: #ffffff;
        }

        .content {
            flex-grow: 1;
            padding: 20px;
            padding-left: calc(250px + 20px); /* Adjust content padding based on sidebar width */
            transition: padding-left 0.3s ease-in-out;
            position: relative;
        }

        .sidebar.hidden ~ .content {
            padding-left: 20px; /* Adjust padding when sidebar is hidden */
        }

        .content-section {
            display: none;
            background: rgba(52, 73, 94, 0.9);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
            margin-bottom: 20px;
        }

        .content-section.active {
            display: block;
        }

        h1, h2, h3 {
            color: #3498db;
            margin-bottom: 20px;
        }

        p {
            line-height: 1.6;
            margin-bottom: 15px;
        }

        /* Welcome Section */
        #welcomeSection label {
            display: block;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        #welcomeSection input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 1px solid #4a6a8a;
            border-radius: 8px;
            background-color: #3f5e7a;
            color: #ecf0f1;
            font-size: 1em;
        }

        #quizCategories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .category-card {
            background-color: #3f5e7a;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .category-card h3 {
            color: #3498db;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .category-card p {
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .start-quiz-btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 15px;
            transition: background-color 0.2s ease;
        }

        .start-quiz-btn:hover {
            background-color: #2980b9;
        }

        /* Quiz Section */
        #quizSection .question-container {
            margin-bottom: 25px;
        }

        #quizSection h2 {
            font-size: 1.5em;
            color: #3498db;
            margin-bottom: 15px;
        }

        #quizSection ul {
            list-style: none;
            padding: 0;
        }

        #quizSection ul li {
            background-color: #3f5e7a;
            margin-bottom: 10px;
            padding: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
            border: 2px solid transparent; /* Default transparent border */
        }

        #quizSection ul li:hover {
            background-color: #4a6a8a;
        }

        #quizSection ul li.selected {
            border-color: #3498db; /* Highlight selected answer */
            background-color: #4a6a8a;
        }
        
        #quizSection ul li.correct {
            background-color: #27ae60; /* Green for correct */
            color: white;
            border-color: #27ae60;
        }

        #quizSection ul li.incorrect {
            background-color: #e74c3c; /* Red for incorrect */
            color: white;
            border-color: #e74c3c;
        }

        #quizSection .quiz-navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .quiz-navigation-buttons button {
            background-color: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.2s ease;
        }

        .quiz-navigation-buttons button:hover {
            background-color: #2980b9;
        }

        .quiz-navigation-buttons button:disabled {
            background-color: #5c7b8d;
            cursor: not-allowed;
        }

        #quizProgressBarContainer {
            width: 100%;
            background-color: #4a6a8a;
            border-radius: 5px;
            margin-top: 20px;
            height: 10px;
            overflow: hidden;
        }

        #quizProgressBar {
            height: 100%;
            width: 0%;
            background-color: #3498db;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }

        #quizTimeTaken {
            margin-top: 10px;
            text-align: right;
            font-size: 0.9em;
            color: #bdc3c7;
        }

        /* Result Section */
        #resultSection {
            text-align: center;
        }

        #resultSection #scoreDisplay {
            font-size: 2.5em;
            color: #2ecc71; /* Green for success */
            margin-bottom: 20px;
        }

        #resultSection p {
            font-size: 1.1em;
            color: #bdc3c7;
            margin-bottom: 10px;
        }

        #resultSection .feedback {
            font-size: 1.2em;
            margin-top: 20px;
            font-weight: bold;
        }
        
        .retake-quiz-btn {
            background-color: #e67e22; /* Orange */
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            margin-top: 20px;
            transition: background-color 0.2s ease;
        }

        .retake-quiz-btn:hover {
            background-color: #d35400;
        }

        /* Admin Dashboard */
        #adminDashboard table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        #adminDashboard th,
        #adminDashboard td {
            border: 1px solid #4a6a8a;
            padding: 12px;
            text-align: left;
        }

        #adminDashboard th {
            background-color: #3f5e7a;
            color: #3498db;
            font-weight: bold;
        }

        #adminDashboard tr:nth-child(even) {
            background-color: #3f5e7a;
        }

        #adminDashboard tr:hover {
            background-color: #4a6a8a;
        }

        .admin-controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .admin-controls button {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .admin-controls button.clear-btn {
            background-color: #e74c3c;
        }

        .admin-controls button.export-btn {
            background-color: #27ae60;
        }

        .admin-controls button:hover {
            background-color: #2980b9;
        }

        .admin-controls button.clear-btn:hover {
            background-color: #c0392b;
        }

        .admin-controls button.export-btn:hover {
            background-color: #229a58;
        }
        
        /* About Section */
        #aboutSection ul {
            list-style: disc;
            margin-left: 20px;
        }

        #aboutSection li {
            margin-bottom: 10px;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 200px;
                transform: translateX(-100%); /* Hidden by default on small screens */
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            .content {
                padding-left: 20px;
            }

            .toggle-btn {
                left: 20px;
            }

            .sidebar.visible + .toggle-btn {
                left: 220px;
            }
        }
    </style>
</head>
<body>
    <button class="toggle-btn" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="sidebar" id="sidebar">
        <div class="logo">
            <img src="https://via.placeholder.com/80/3498db/FFFFFF?text=Quiz" alt="Logo">
            <h2>QuizMaster</h2>
        </div>
        <ul class="nav-links">
            <li><a href="#" data-section="welcomeSection" class="active"><i class="fas fa-home"></i> Welcome</a></li>
            <li><a href="#" data-section="adminDashboard"><i class="fas fa-tachometer-alt"></i> Admin Dashboard</a></li>
            <li><a href="#" data-section="aboutSection"><i class="fas fa-info-circle"></i> About</a></li>
        </ul>
    </div>

    <div class="content">
        <section id="welcomeSection" class="content-section active">
            <h1>Welcome to the English Quiz System!</h1>
            <p>Test your English knowledge across various categories. Enter your name below to begin.</p>
            <label for="userNameInput">Your Name:</label>
            <input type="text" id="userNameInput" placeholder="Enter your name" required>

            <h2>Choose a Quiz Category:</h2>
            <div id="quizCategories">
                </div>
        </section>

        <section id="quizSection" class="content-section">
            <h1 id="quizTitleDisplay"></h1>
            <div id="quizProgressBarContainer">
                <div id="quizProgressBar"></div>
            </div>
            <p id="quizTimeTaken">Time: 0s</p>
            <div class="question-container">
                <h2 id="questionText"></h2>
                <ul id="answerOptions">
                    </ul>
            </div>
            <div class="quiz-navigation-buttons">
                <button id="prevQuestionBtn" disabled>Previous</button>
                <button id="nextQuestionBtn">Next</button>
                <button id="currentQuizSubmitBtn" style="display:none;">Submit Quiz</button>
            </div>
        </section>

        <section id="resultSection" class="content-section">
            <h1>Quiz Results</h1>
            <p>Congratulations, <span id="finalUserName"></span>!</p>
            <p>You completed the <span id="finalQuizCategory"></span> quiz.</p>
            <div id="scoreDisplay"></div>
            <p id="timeTakenDisplay"></p>
            <p class="feedback" id="feedbackMessage"></p>
            <button class="retake-quiz-btn" onclick="showSection('welcomeSection')">Back to Quizzes</button>
        </section>

        <section id="adminDashboard" class="content-section">
            <h1>Admin Dashboard</h1>
            <p>View all quiz results from participants.</p>
            <div class="admin-controls">
                <button class="export-btn" onclick="exportAllQuizData()">Export All Results (CSV)</button>
                </div>
            <table>
                <thead>
                    <tr>
                        <th>User Name</th>
                        <th>Category</th>
                        <th>Quiz Title</th>
                        <th>Score</th>
                        <th>Time Taken</th>
                    </tr>
                </thead>
                <tbody id="adminResultsTableBody">
                    </tbody>
            </table>
        </section>

        <section id="aboutSection" class="content-section">
            <h1>About This Quiz System</h1>
            <p>This is an interactive English quiz system designed to help users test and improve their English language skills. It covers various categories to provide a comprehensive learning experience.</p>
            <h2>Features:</h2>
            <ul>
                <li>Multiple quiz categories (Grammar, Vocabulary, Listening).</li>
                <li>Interactive question display with multiple-choice answers.</li>
                <li>Real-time score tracking and time taken.</li>
                <li>Admin dashboard to view all participant results (now from server).</li>
                <li>Export results to CSV.</li>
            </ul>
            <h2>How to Use:</h2>
            <ol>
                <li>Enter your name on the Welcome screen.</li>
                <li>Choose a quiz category to start.</li>
                <li>Answer the questions and navigate using 'Previous'/'Next' buttons.</li>
                <li>Submit your quiz to see your results.</li>
                <li>Access the Admin Dashboard to see all participant scores.</li>
            </ol>
            <p>Developed for JEDAT Engineers.</p>
        </section>
    </div>

    <script>
        // --- Core Quiz Data and Variables ---
        let currentQuizData = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizStartTime;
        let selectedAnswers = []; // To store selected answer for each question

        // Note: userData will now be populated from the server for the admin dashboard.
        // It's no longer the source of truth for individual user data before submission.
        let userData = []; 

        const quizzes = {
            "Grammar Basics": [
                {
                    question: "Choose the correct sentence:",
                    options: [
                        "He don't like coffee.",
                        "He doesn't like coffee.",
                        "He not like coffee.",
                        "He isn't like coffee."
                    ],
                    correctAnswer: "He doesn't like coffee.",
                    category: "Grammar Basics",
                    title: "Grammar Basics"
                },
                {
                    question: "Identify the plural form of 'child':",
                    options: [
                        "childs",
                        "childrens",
                        "children",
                        "child's"
                    ],
                    correctAnswer: "children",
                    category: "Grammar Basics",
                    title: "Grammar Basics"
                },
                {
                    question: "Complete the sentence: 'She ___ happy with her new job.'",
                    options: [
                        "is",
                        "are",
                        "am",
                        "be"
                    ],
                    correctAnswer: "is",
                    category: "Grammar Basics",
                    title: "Grammar Basics"
                },
                {
                    question: "Which of the following is a demonstrative pronoun?",
                    options: [
                        "I",
                        "you",
                        "this",
                        "run"
                    ],
                    correctAnswer: "this",
                    category: "Grammar Basics",
                    title: "Grammar Basics"
                },
                {
                    question: "Choose the correct past tense of 'go':",
                    options: [
                        "goed",
                        "went",
                        "gone",
                        "going"
                    ],
                    correctAnswer: "went",
                    category: "Grammar Basics",
                    title: "Grammar Basics"
                }
            ],
            "Vocabulary Builder": [
                {
                    question: "What is the synonym of 'diligent'?",
                    options: [
                        "lazy",
                        "hardworking",
                        "careless",
                        "slow"
                    ],
                    correctAnswer: "hardworking",
                    category: "Vocabulary Builder",
                    title: "Vocabulary Builder"
                },
                {
                    question: "Choose the antonym of 'ancient':",
                    options: [
                        "old",
                        "modern",
                        "historic",
                        "classic"
                    ],
                    correctAnswer: "modern",
                    category: "Vocabulary Builder",
                    title: "Vocabulary Builder"
                },
                {
                    question: "What does 'benevolent' mean?",
                    options: [
                        "mean",
                        "kind",
                        "angry",
                        "sad"
                    ],
                    correctAnswer: "kind",
                    category: "Vocabulary Builder",
                    title: "Vocabulary Builder"
                },
                {
                    question: "Which word means 'to make something less severe'?",
                    options: [
                        "aggravate",
                        "exacerbate",
                        "alleviate",
                        "intensify"
                    ],
                    correctAnswer: "alleviate",
                    category: "Vocabulary Builder",
                    title: "Vocabulary Builder"
                },
                {
                    question: "A 'gregarious' person is:",
                    options: [
                        "shy",
                        "sociable",
                        "solitary",
                        "introverted"
                    ],
                    correctAnswer: "sociable",
                    category: "Vocabulary Builder",
                    title: "Vocabulary Builder"
                }
            ],
            "Listening Comprehension": [
                {
                    question: "If someone says 'It's raining cats and dogs', what do they mean?",
                    options: [
                        "Animals are falling from the sky.",
                        "It's raining very heavily.",
                        "It's not raining at all.",
                        "Cats and dogs are fighting."
                    ],
                    correctAnswer: "It's raining very heavily.",
                    category: "Listening Comprehension",
                    title: "Listening Comprehension"
                },
                {
                    question: "What does 'break a leg' mean in English idioms?",
                    options: [
                        "To actually break your leg.",
                        "To wish someone good luck.",
                        "To fall down.",
                        "To be clumsy."
                    ],
                    correctAnswer: "To wish someone good luck.",
                    category: "Listening Comprehension",
                    title: "Listening Comprehension"
                },
                {
                    question: "If you 'bite the bullet', what are you doing?",
                    options: [
                        "Eating quickly.",
                        "Facing a difficult situation with courage.",
                        "Fighting with someone.",
                        "Ignoring a problem."
                    ],
                    correctAnswer: "Facing a difficult situation with courage.",
                    category: "Listening Comprehension",
                    title: "Listening Comprehension"
                },
                {
                    question: "What does 'hit the road' mean?",
                    options: [
                        "To get into an accident.",
                        "To start a journey.",
                        "To punch the ground.",
                        "To take a break."
                    ],
                    correctAnswer: "To start a journey.",
                    category: "Listening Comprehension",
                    title: "Listening Comprehension"
                },
                {
                    question: "If someone tells you to 'cut to the chase', what do they want?",
                    options: [
                        "To stop talking and get to the main point.",
                        "To run faster.",
                        "To physically cut something.",
                        "To follow a long story."
                    ],
                    correctAnswer: "To stop talking and get to the main point.",
                    category: "Listening Comprehension",
                    title: "Listening Comprehension"
                }
            ]
        };

        const sections = document.querySelectorAll('.content-section');
        const navLinks = document.querySelectorAll('.nav-links a');
        const quizCategoriesDiv = document.getElementById('quizCategories');
        const userNameInput = document.getElementById('userNameInput');
        const questionText = document.getElementById('questionText');
        const answerOptionsUl = document.getElementById('answerOptions');
        const prevQuestionBtn = document.getElementById('prevQuestionBtn');
        const nextQuestionBtn = document.getElementById('nextQuestionBtn');
        const currentQuizSubmitBtn = document.getElementById('currentQuizSubmitBtn');
        const quizProgressBar = document.getElementById('quizProgressBar');
        const quizProgressBarContainer = document.getElementById('quizProgressBarContainer');
        const quizTimeTakenDisplay = document.getElementById('quizTimeTaken');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const finalUserName = document.getElementById('finalUserName');
        const finalQuizCategory = document.getElementById('finalQuizCategory');
        const timeTakenDisplay = document.getElementById('timeTakenDisplay');
        const feedbackMessage = document.getElementById('feedbackMessage');
        const adminResultsTableBody = document.getElementById('adminResultsTableBody');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');

        let quizTimerInterval;

        // --- Navigation and Section Display ---
        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');

            navLinks.forEach(link => {
                link.classList.remove('active');
                if (link.dataset.section === sectionId) {
                    link.classList.add('active');
                }
            });

            // Special handling for admin dashboard: fetch data when shown
            if (sectionId === 'adminDashboard') {
                fetchAllUserData(); 
            }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showSection(this.dataset.section);
            });
        });

        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('hidden');
        });

        // --- Welcome Section / Category Loading ---
        function loadQuizCategories() {
            quizCategoriesDiv.innerHTML = '';
            for (const category in quizzes) {
                const card = document.createElement('div');
                card.classList.add('category-card');
                card.innerHTML = `
                    <h3>${category}</h3>
                    <p>${quizzes[category].length} Questions</p>
                    <button class="start-quiz-btn" data-category="${category}">Start Quiz</button>
                `;
                quizCategoriesDiv.appendChild(card);
            }

            document.querySelectorAll('.start-quiz-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const userName = userNameInput.value.trim();
                    if (!userName) {
                        alert('Please enter your name to start the quiz.');
                        return;
                    }
                    const category = e.target.dataset.category;
                    startQuiz(category, category); // Using category as title for simplicity
                });
            });
        }

        // --- Quiz Logic ---
        function startQuiz(category, title) {
            currentQuizData = quizzes[category].map(q => ({ ...q, category, title }));
            currentQuestionIndex = 0;
            score = 0;
            selectedAnswers = new Array(currentQuizData.length).fill(null); // Reset selected answers for new quiz
            quizStartTime = new Date();
            clearInterval(quizTimerInterval); // Clear any previous timer
            updateQuizTimer(); // Start new timer immediately
            quizTimerInterval = setInterval(updateQuizTimer, 1000);

            quizProgressBarContainer.style.display = 'block';
            quizTimeTakenDisplay.style.display = 'block';
            currentQuizSubmitBtn.style.display = 'none'; // Hide submit button initially

            showSection('quizSection');
            displayQuestion();
        }

        function displayQuestion() {
            if (currentQuestionIndex < 0 || currentQuestionIndex >= currentQuizData.length) {
                return; // Should not happen
            }

            const question = currentQuizData[currentQuestionIndex];
            document.getElementById('quizTitleDisplay').textContent = `${question.category} - Question ${currentQuestionIndex + 1} of ${currentQuizData.length}`;
            questionText.textContent = question.question;
            answerOptionsUl.innerHTML = '';

            question.options.forEach((option, index) => {
                const li = document.createElement('li');
                li.textContent = option;
                li.dataset.index = index; // Store original index for selection
                li.addEventListener('click', () => selectAnswer(li, option));

                // If an answer was previously selected for this question, highlight it
                if (selectedAnswers[currentQuestionIndex] === option) {
                    li.classList.add('selected');
                }
                answerOptionsUl.appendChild(li);
            });

            prevQuestionBtn.disabled = currentQuestionIndex === 0;
            nextQuestionBtn.textContent = currentQuestionIndex === currentQuizData.length - 1 ? 'Review' : 'Next';
            currentQuizSubmitBtn.style.display = currentQuestionIndex === currentQuizData.length - 1 ? 'block' : 'none';

            updateProgressBar();
        }

        function selectAnswer(selectedLi, answerText) {
            // Remove 'selected' from all options for the current question
            answerOptionsUl.querySelectorAll('li').forEach(li => {
                li.classList.remove('selected');
            });
            // Add 'selected' to the clicked option
            selectedLi.classList.add('selected');
            selectedAnswers[currentQuestionIndex] = answerText; // Store the selected answer
        }

        function navigateQuiz(direction) {
            if (direction === 'next') {
                if (currentQuestionIndex < currentQuizData.length - 1) {
                    currentQuestionIndex++;
                } else if (currentQuestionIndex === currentQuizData.length - 1) {
                    // This is the last question, "Next" acts as "Review" or "Submit" prompt
                    // Here we'll just ensure it highlights the submit button
                    currentQuizSubmitBtn.focus(); // Visually highlight submit
                }
            } else if (direction === 'prev') {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                }
            }
            displayQuestion();
        }

        nextQuestionBtn.addEventListener('click', () => navigateQuiz('next'));
        prevQuestionBtn.addEventListener('click', () => navigateQuiz('prev'));
        currentQuizSubmitBtn.addEventListener('click', submitQuiz);

        function updateProgressBar() {
            const progress = ((currentQuestionIndex + 1) / currentQuizData.length) * 100;
            quizProgressBar.style.width = `${progress}%`;
        }

        function updateQuizTimer() {
            const timeElapsed = Math.round((new Date() - quizStartTime) / 1000);
            quizTimeTakenDisplay.textContent = `Time: ${timeElapsed}s`;
        }

        function submitQuiz() {
            clearInterval(quizTimerInterval); // Stop the timer

            score = 0; // Reset score before recalculating
            currentQuizData.forEach((question, index) => {
                if (selectedAnswers[index] === question.correctAnswer) {
                    score++;
                }
            });
            showResultScreen();
        }

        function showResultScreen() {
            const userName = userNameInput.value;
            const timeTaken = Math.round((new Date() - quizStartTime) / 1000); // in seconds
            const quizCategory = currentQuizData[0].category; // Assuming category is consistent
            const quizTitle = currentQuizData[0].title; // Assuming title is consistent

            finalUserName.textContent = userName;
            finalQuizCategory.textContent = quizCategory;
            scoreDisplay.textContent = `Score: ${score} / ${currentQuizData.length}`;
            timeTakenDisplay.textContent = `Time Taken: ${timeTaken} seconds`;

            let feedback = "";
            const percentage = (score / currentQuizData.length) * 100;
            if (percentage >= 80) {
                feedback = "Excellent! You did great!";
                scoreDisplay.style.color = '#2ecc71';
            } else if (percentage >= 50) {
                feedback = "Good job! Keep practicing.";
                scoreDisplay.style.color = '#f1c40f';
            } else {
                feedback = "You might want to review the topics and try again.";
                scoreDisplay.style.color = '#e74c3c';
            }
            feedbackMessage.textContent = feedback;

            // --- IMPORTANT CHANGE: Send results to server ---
            sendQuizResultsToServer({
                userName: userName,
                quizCategory: quizCategory,
                quizTitle: quizTitle,
                score: score,
                totalQuestions: currentQuizData.length,
                timeTaken: timeTaken
            });

            showSection('resultSection');
        }

        // --- NEW: Function to send quiz results to the Netlify Function ---
        async function sendQuizResultsToServer(results) {
            try {
                // The URL for your Netlify Function
                // This path will work automatically once deployed to Netlify
                const netlifyFunctionUrl = '/.netlify/functions/submit-quiz'; 

                const response = await fetch(netlifyFunctionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(results),
                });

                if (response.ok) {
                    console.log('Quiz results submitted successfully to server!');
                } else {
                    const errorData = await response.json();
                    console.error('Failed to submit quiz results to server:', response.status, response.statusText, errorData);
                    alert('Error submitting quiz results. Please try again.');
                }
            } catch (error) {
                console.error('Network error sending quiz results:', error);
                alert('Network error. Could not submit quiz results.');
            }
        }

        // --- NEW: Function to fetch all user data for admin dashboard from Netlify Function ---
        async function fetchAllUserData() {
            adminResultsTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading results...</td></tr>';
            try {
                // The URL for your Netlify Function to get results
                const netlifyFunctionUrl = '/.netlify/functions/get-results'; 

                const response = await fetch(netlifyFunctionUrl);
                if (response.ok) {
                    const data = await response.json();
                    userData = data; // Update local userData with data from server
                    console.log('User data fetched from server:', userData);
                    displayAdminDashboard(); // Refresh the dashboard table
                } else {
                    const errorData = await response.json();
                    console.error('Failed to fetch user data from server:', response.status, response.statusText, errorData);
                    userData = []; // Clear data if fetch fails
                    displayAdminDashboard(); // Show empty dashboard
                }
            } catch (error) {
                console.error('Network error fetching user data:', error);
                userData = [];
                displayAdminDashboard(); // Show empty dashboard on network error
            }
        }

        // --- Admin Dashboard Display (modified to use fetched data) ---
        function displayAdminDashboard() {
            adminResultsTableBody.innerHTML = ''; // Clear existing rows

            if (!userData || userData.length === 0) {
                const row = adminResultsTableBody.insertRow();
                const cell = row.insertCell(0);
                cell.colSpan = 5;
                cell.textContent = "No quiz data available.";
                cell.style.textAlign = "center";
                return;
            }

            userData.forEach(data => {
                const row = adminResultsTableBody.insertRow();
                row.insertCell(0).textContent = data.userName;
                row.insertCell(1).textContent = data.quizCategory;
                row.insertCell(2).textContent = data.quizTitle;
                row.insertCell(3).textContent = `${data.score}/${data.totalQuestions}`;
                row.insertCell(4).textContent = `${data.timeTaken}s`;
            });
        }
        
        // --- DEPRECATED/MODIFIED: Functions related to localStorage ---
        // These are no longer needed for central storage but kept for structure.
        // The loadUserData() is now responsible for initiating server data fetch.
        function loadUserData() {
            // This function is now primarily responsible for initiating the fetch from the server
            // when the admin dashboard might be viewed.
            // It also loads quiz categories for the welcome screen.
            loadQuizCategories();
            // Don't call fetchAllUserData here if you don't want it to load on *every* page load.
            // It's called specifically when admin dashboard is selected.
        }

        function saveUserData() {
            // This function, which used localStorage, is no longer relevant for shared data.
            console.warn("saveUserData() is deprecated as data is now server-managed by Netlify Function.");
        }

        function clearUserData() {
            // Clearing data would require an API call to the server to delete records from Neon.
            // This functionality is removed from the HTML for simplicity, as it requires another backend endpoint.
            alert("Clearing data for all users requires a backend API. This feature is currently disabled.");
            console.warn("Clear data functionality requires a backend endpoint and is not implemented in this client-side code.");
        }

        // Export data now exports what's currently loaded into 'userData' from the server
        function exportAllQuizData() {
            if (!userData || userData.length === 0) {
                alert("No data to export.");
                return;
            }
            console.log("Exporting current dashboard data (fetched from server).");
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "User Name,Quiz Category,Quiz Title,Score,Total Questions,Time Taken\r\n";

            userData.forEach(row => {
                let rowData = [
                    row.userName,
                    row.quizCategory,
                    row.quizTitle,
                    row.score,
                    row.totalQuestions,
                    row.timeTaken
                ].map(item => `"${String(item).replace(/"/g, '""')}"`).join(","); // Quote items and escape internal quotes
                csvContent += rowData + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "all_quiz_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserData(); // Initial setup for welcome screen and categories
            document.getElementById('currentQuizSubmitBtn').style.display = 'none';
            document.getElementById('quizProgressBarContainer').style.display = 'none';
            document.getElementById('quizTimeTaken').style.display = 'none';
        });

    </script>
</body>
</html>